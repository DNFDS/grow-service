node{
    properties([pipelineTriggers([githubPush()])])

    step([$class: 'WsCleanup'])

    stage('Checkout') {
        git url: 'https://github.com/seabornlee/grow.git', branch: 'master'
    }

    stage('Test') {
        sh './gradlew test'
    }

    stage('Build') {
        sh './gradlew build'
    }

    withEnv(['IMAGE_REGISTRY=registry-internal.cn-shanghai.aliyuncs.com/agile-training/agile-training',
                 'IMAGE_REPO=grow-service']) {

        stage('GenImage') {
            sh 'bash ./ci/genImage.sh'
        }
    }
}